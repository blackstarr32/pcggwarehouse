<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warehouse Inventory</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom tweaks for warehouse feel */
        body { 
            background-color: #f3f4f6; 
            touch-action: manipulation; /* Improves touch response */
        }
        .input-field {
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }
        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            outline: none;
        }
        /* Hide number spinner arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* Sticky footer adjustments */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center z-10">
        <div>
            <h1 class="font-bold text-xl tracking-wide">SCANNER<span class="text-blue-400">PRO</span></h1>
            <p class="text-xs text-gray-400">Inventory v1.2</p>
        </div>
        <button onclick="downloadSheet()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded text-sm font-medium flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export
        </button>
    </header>

    <!-- Main Scrollable Content -->
    <main class="flex-1 overflow-y-auto p-4 pb-32">
        
        <!-- Main Form -->
        <form id="inventoryForm" class="space-y-4 max-w-md mx-auto">

            <!-- Product Details Group -->
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                
                <!-- 1. Product Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="product" class="input-field w-full text-lg p-3 rounded-lg" placeholder="e.g. Graphic Tee" autofocus required>
                </div>

                <!-- 2. SKU -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SKU / Barcode</label>
                    <input type="text" id="sku" class="input-field w-full text-lg p-3 rounded-lg font-mono" placeholder="Scan or type..." required>
                </div>

                <!-- 3. Color & Size Row (Free Text) -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                        <input type="text" id="color" class="input-field w-full text-lg p-3 rounded-lg" placeholder="e.g. Navy" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
                        <input type="text" id="size" class="input-field w-full text-lg p-3 rounded-lg" placeholder="e.g. XL" required>
                    </div>
                </div>

            </div>

            <!-- 4. Bin Location (4 Separate Fields) -->
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-400">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Bin Location (Zone - Aisle - Rack - Level)</label>
                <div class="grid grid-cols-4 gap-2">
                    <input type="text" id="bin1" class="input-field w-full text-center text-xl font-mono font-bold p-2 rounded-lg bg-yellow-50 text-gray-900 uppercase" placeholder="A" required>
                    <input type="text" id="bin2" class="input-field w-full text-center text-xl font-mono font-bold p-2 rounded-lg bg-yellow-50 text-gray-900 uppercase" placeholder="01" required>
                    <input type="text" id="bin3" class="input-field w-full text-center text-xl font-mono font-bold p-2 rounded-lg bg-yellow-50 text-gray-900 uppercase" placeholder="04" required>
                    <input type="text" id="bin4" class="input-field w-full text-center text-xl font-mono font-bold p-2 rounded-lg bg-yellow-50 text-gray-900 uppercase" placeholder="B" required>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-right">Remembers last location</p>
            </div>

            <!-- 5. Quantity Stepper -->
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                <div class="flex items-center">
                    <button type="button" onclick="adjustQty(-1)" class="w-16 h-16 rounded-l-lg bg-gray-200 text-gray-600 hover:bg-gray-300 active:bg-gray-400 text-3xl font-bold touch-manipulation">-</button>
                    <input type="number" id="qty" value="1" class="input-field w-full h-16 text-center text-3xl font-bold border-l-0 border-r-0 rounded-none z-0" inputmode="numeric" required>
                    <button type="button" onclick="adjustQty(1)" class="w-16 h-16 rounded-r-lg bg-blue-100 text-blue-600 hover:bg-blue-200 active:bg-blue-300 text-3xl font-bold touch-manipulation">+</button>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="mt-6">
                <h3 class="text-sm font-bold text-gray-500 uppercase mb-2">Recent Scans (This Session)</h3>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <table class="min-w-full text-sm">
                        <tbody id="recentScans" class="divide-y divide-gray-100">
                            <!-- Rows added here via JS -->
                            <tr class="text-gray-400 italic">
                                <td class="p-3 text-center">No items scanned yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </form>
    </main>

    <!-- Sticky Footer Submit -->
    <footer class="fixed bottom-0 w-full bg-white border-t border-gray-200 p-4 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
        <button id="submitBtn" onclick="submitForm()" class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold text-xl py-4 rounded-xl shadow-lg transition-colors flex justify-center items-center gap-3">
            <span>Save to Inventory</span>
            <span id="spinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span>
        </button>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
        <span>Inventory Saved!</span>
    </div>

    <!-- Logic -->
    <script>
        // ************************************************
        // CONFIGURATION: PASTE YOUR DEPLOYED URL HERE
        // ************************************************
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxb3XFuomomAqFS-60OfOYU2oqUuV9auGHf15e1A8JOyw3f3rOothuPNjKcHv6D_JoG/exec"; 
        
        // State
        let spreadsheetId = null;

        // On Load
        document.addEventListener('DOMContentLoaded', () => {
            // Restore Bin Locations from local storage (now 4 parts)
            const b1 = localStorage.getItem('wh_bin_1');
            const b2 = localStorage.getItem('wh_bin_2');
            const b3 = localStorage.getItem('wh_bin_3');
            const b4 = localStorage.getItem('wh_bin_4');

            if (b1) document.getElementById('bin1').value = b1;
            if (b2) document.getElementById('bin2').value = b2;
            if (b3) document.getElementById('bin3').value = b3;
            if (b4) document.getElementById('bin4').value = b4;

            // Get Spreadsheet ID for export function
            fetch(WEB_APP_URL)
                .then(res => res.json())
                .then(data => {
                    spreadsheetId = data.spreadsheetId;
                    console.log("Connected to Sheet:", data.sheetName);
                })
                .catch(err => console.log("Init fetch warning:", err));
        });

        // Quantity Stepper Logic
        function adjustQty(amount) {
            const input = document.getElementById('qty');
            let val = parseInt(input.value) || 0;
            val += amount;
            if (val < 1) val = 1;
            input.value = val;
        }

        // Form Submission
        function submitForm() {
            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('spinner');
            const form = document.getElementById('inventoryForm');

            // Validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Gather Bin Data 
            const b1 = document.getElementById('bin1').value.toUpperCase().trim();
            const b2 = document.getElementById('bin2').value.toUpperCase().trim();
            const b3 = document.getElementById('bin3').value.toUpperCase().trim();
            const b4 = document.getElementById('bin4').value.toUpperCase().trim();

            // Gather Data
            const data = {
                sku: document.getElementById('sku').value,
                product: document.getElementById('product').value,
                color: document.getElementById('color').value,
                size: document.getElementById('size').value,
                qty: document.getElementById('qty').value,
                bin1: b1,
                bin2: b2,
                bin3: b3,
                bin4: b4
            };

            // UI Loading State
            btn.disabled = true;
            btn.classList.add('opacity-75');
            btn.querySelector('span:first-child').innerText = "Saving...";
            spinner.classList.remove('hidden');

            // Save Separate Bin Parts to LocalStorage
            localStorage.setItem('wh_bin_1', b1);
            localStorage.setItem('wh_bin_2', b2);
            localStorage.setItem('wh_bin_3', b3);
            localStorage.setItem('wh_bin_4', b4);

            // Send Data to Apps Script
            fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors", // Essential for Google Apps Script simple triggers
                headers: {
                    "Content-Type": "text/plain" // Prevents OPTIONS preflight check
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                // Because mode is no-cors, we assume success if no network error
                handleSuccess(data);
            })
            .catch(error => {
                alert("Error saving: " + error);
            })
            .finally(() => {
                // Reset UI
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                btn.querySelector('span:first-child').innerText = "Save to Inventory";
                spinner.classList.add('hidden');
            });
        }

        function handleSuccess(data) {
            // Show Toast
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2500);

            // Add to Recent Scans Table
            const tbody = document.getElementById('recentScans');
            if (tbody.children[0].innerText.includes('No items')) tbody.innerHTML = '';
            
            // Format bin display for the recent scans list
            const binDisplay = `${data.bin1}-${data.bin2}-${data.bin3}-${data.bin4}`;

            const row = `
                <tr class="bg-blue-50 border-b border-gray-100 animate-[fadeIn_0.5s]">
                    <td class="p-3">
                        <div class="font-bold text-gray-800">${data.product}</div>
                        <div class="text-xs text-gray-500">Bin: ${binDisplay}</div>
                    </td>
                    <td class="p-3 text-right">
                        <div class="font-bold text-gray-800">${data.qty}</div>
                        <div class="text-xs text-gray-500">${data.color} / ${data.size}</div>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('afterbegin', row);

            // Keep list to 5 items
            if (tbody.children.length > 5) tbody.lastElementChild.remove();

            // Clear Form (Except Bin Locations)
            document.getElementById('sku').value = '';
            document.getElementById('product').value = '';
            document.getElementById('color').value = '';
            document.getElementById('size').value = '';
            document.getElementById('qty').value = '1';
            
            // Refocus Product Name (First field)
            document.getElementById('product').focus();
        }

        function downloadSheet() {
            if (!spreadsheetId) {
                alert("Connecting to sheet... try again in a second.");
                return;
            }
            // Direct download link for Excel
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=xlsx`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>